<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RuralNow - Lo auténtico, a un mapa de distancia</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2E7D32', 
                        secondary: '#E65100', 
                        surface: '#F5F5F7', 
                        dark: '#1A1A1A'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Montserrat', 'serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'slide-up': 'slideUp 0.4s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: { from: { opacity: 0 }, to: { opacity: 1 } },
                        slideUp: { from: { transform: 'translateY(20px)', opacity: 0 }, to: { transform: 'translateY(0)', opacity: 1 } }
                    }
                }
            }
        }
    </script>

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --header-height: 4rem; }
        body { font-family: 'Inter', sans-serif; background-color: #F5F5F7; height: 100vh; overflow: hidden; }
        h1, h2, h3, h4 { font-family: 'Montserrat', serif; }
        
        ::-webkit-scrollbar { width: 0.4rem; height: 0.4rem; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #2E7D32; border-radius: 0.2rem; }
        
        .leaflet-popup-content-wrapper { border-radius: 0.75rem; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; width: 16rem !important; }
        .grid-responsive { display: grid; grid-template-columns: repeat(auto-fill, minmax(18rem, 1fr)); gap: 1.5rem; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">

    // --- MOCK DATA ---
    const PRODUCTS = [
        { id: 1, name: "Miel de Romero Ecológica", category: "Alimentación", price: "12€ / kg", producer: "Apiarios La Alcarria", location: "Brihuega, Guadalajara", coords: [40.7594, -2.8714], image: "https://images.unsplash.com/photo-1587049352846-4a222e784d38?auto=format&fit=crop&w=800", avatar: "https://randomuser.me/api/portraits/men/32.jpg", story: "Miel cruda sin pasteurizar. 4 generaciones de apicultores.", tags: ["Eco", "Artesanal"] },
        { id: 2, name: "Queso Manchego Curado", category: "Alimentación", price: "24€ / kg", producer: "Quesería El Pastor", location: "Tembleque, Toledo", coords: [39.6974, -3.5029], image: "https://images.unsplash.com/photo-1486297678162-eb2a19b0a32d?auto=format&fit=crop&w=800", avatar: "https://randomuser.me/api/portraits/women/44.jpg", story: "Leche cruda de oveja manchega. Curación en cueva.", tags: ["D.O.P", "Premiado"] },
        { id: 3, name: "Cerámica Negra", category: "Artesanía", price: "35€ / pieza", producer: "Alfarería Juanito", location: "Verdicio, Asturias", coords: [43.626, -5.882], image: "https://images.unsplash.com/photo-1610701596007-11502861dcfa?auto=format&fit=crop&w=800", avatar: "https://randomuser.me/api/portraits/men/85.jpg", story: "Técnica ancestral de horno de leña reductor.", tags: ["Patrimonio", "Decoración"] },
        { id: 4, name: "Vino Tinto Crianza", category: "Bebida", price: "15€ / botella", producer: "Bodegas Familiares", location: "Haro, La Rioja", coords: [42.5769, -2.8519], image: "https://images.unsplash.com/photo-1510812431401-41d2bd2722f3?auto=format&fit=crop&w=800", avatar: "https://randomuser.me/api/portraits/women/68.jpg", story: "Viñedos centenarios y variedades autóctonas.", tags: ["Enoturismo"] },
        { id: 5, name: "Aceite AOVE Picual", category: "Alimentación", price: "45€ / 5L", producer: "Coop. Oro Líquido", location: "Úbeda, Jaén", coords: [38.0118, -3.3713], image: "https://images.unsplash.com/photo-1474979266404-7cadd259d3cf?auto=format&fit=crop&w=800", avatar: "https://randomuser.me/api/portraits/men/12.jpg", story: "Recolección temprana, extracción en frío.", tags: ["AOVE", "Gourmet"] }
    ];

    const ROUTES = [
        { id: 1, title: "Ruta de la Miel", location: "La Alcarria", duration: "1 Día", stops: 4, image: "https://images.unsplash.com/photo-1473973266708-19e99968b541?auto=format&fit=crop&w=800", desc: "Descubre los campos de lavanda y las colmenas tradicionales." },
        { id: 2, title: "Ruta del Quijote Gastronómico", location: "Castilla-La Mancha", duration: "Weekend", stops: 6, image: "https://images.unsplash.com/photo-1500382017468-9049fed747ef?auto=format&fit=crop&w=800", desc: "Queso, vino y azafrán en escenarios de novela." },
        { id: 3, title: "Sabores del Norte", location: "Asturias y Cantabria", duration: "3 Días", stops: 8, image: "https://images.unsplash.com/photo-1533280385001-c32ff4cb7633?auto=format&fit=crop&w=800", desc: "Sidra, queso azul y alfarería negra entre montañas." }
    ];

    const BADGES = [
        { id: 1, name: "Primeros Pasos", icon: "fa-person-hiking", unlocked: true, desc: "Has visitado tu primer pueblo." },
        { id: 2, name: "Gourmet Rural", icon: "fa-utensils", unlocked: true, desc: "Has comprado 3 productos de alimentación." },
        { id: 3, name: "Mecenas", icon: "fa-hand-holding-heart", unlocked: false, desc: "Apoya a 5 artesanos diferentes." },
        { id: 4, name: "Explorador", icon: "fa-map-location-dot", unlocked: false, desc: "Completa una Ruta oficial." }
    ];

    // --- COMPONENTES UI ---

    const Header = ({ activeTab, onTabChange }) => {
        const tabs = [
            { id: 'map', label: 'Mapa', icon: 'fa-map' },
            { id: 'producers', label: 'Productores', icon: 'fa-shop' },
            { id: 'routes', label: 'Rutas', icon: 'fa-route' },
            { id: 'passport', label: 'Pasaporte', icon: 'fa-passport' }
        ];

        return (
            <nav className="bg-white shadow-sm sticky top-0 z-50 h-16 shrink-0">
                <div className="max-w-7xl mx-auto px-4 h-full flex justify-between items-center">
                    <div className="flex items-center gap-2 cursor-pointer" onClick={() => onTabChange('map')}>
                        <div className="bg-primary text-white p-1.5 rounded-lg shadow-sm">
                            <i className="fa-solid fa-location-dot text-lg"></i>
                        </div>
                        <span className="font-serif font-bold text-xl md:text-2xl text-primary tracking-tight">RuralNow</span>
                    </div>

                    <div className="hidden md:flex space-x-1 bg-gray-100 p-1 rounded-xl">
                        {tabs.map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => onTabChange(tab.id)}
                                className={`px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-2 ${
                                    activeTab === tab.id 
                                    ? 'bg-white text-primary shadow-sm font-bold' 
                                    : 'text-gray-500 hover:text-gray-700'
                                }`}
                            >
                                <i className={`fa-solid ${tab.icon}`}></i> {tab.label}
                            </button>
                        ))}
                    </div>

                    <button className="md:hidden text-gray-600"><i className="fa-solid fa-bars text-xl"></i></button>

                    <button className="hidden sm:block bg-secondary text-white px-4 py-2 rounded-full text-xs font-bold hover:bg-orange-700 transition shadow-md">
                        Soy Productor
                    </button>
                </div>
                <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around p-3 z-50 pb-safe">
                    {tabs.map(tab => (
                        <button 
                            key={tab.id}
                            onClick={() => onTabChange(tab.id)}
                            className={`flex flex-col items-center gap-1 text-[0.65rem] ${activeTab === tab.id ? 'text-primary' : 'text-gray-400'}`}
                        >
                            <i className={`fa-solid ${tab.icon} text-lg ${activeTab === tab.id ? 'animate-bounce' : ''}`}></i>
                            {tab.label}
                        </button>
                    ))}
                </div>
            </nav>
        );
    };

    // --- VISTAS ---

    // 1. VISTA MAPA (Core) - FIXED: Use useRef for instance and proper cleanup
    const MapView = ({ products, onSelect }) => {
        const mapContainerRef = React.useRef(null);
        const mapInstanceRef = React.useRef(null);
        const markersRef = React.useRef([]);
        const [searchTerm, setSearchTerm] = React.useState("");

        const filtered = products.filter(p => 
            p.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
            p.category.toLowerCase().includes(searchTerm.toLowerCase())
        );

        // 1. Inicialización del Mapa (Solo una vez)
        React.useEffect(() => {
            if (!mapInstanceRef.current && mapContainerRef.current) {
                const map = L.map(mapContainerRef.current, { zoomControl: false }).setView([40.4168, -3.7038], 5);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
                L.control.zoom({ position: 'bottomright' }).addTo(map);
                mapInstanceRef.current = map;
            }

            // Cleanup al desmontar el componente (Cambio de Pestaña)
            return () => {
                if (mapInstanceRef.current) {
                    mapInstanceRef.current.remove();
                    mapInstanceRef.current = null;
                }
            };
        }, []);

        // 2. Gestión de Marcadores (Cada vez que cambia el filtro)
        React.useEffect(() => {
            if (!mapInstanceRef.current) return;

            // Limpiar anteriores
            markersRef.current.forEach(m => m.remove());
            markersRef.current = [];

            // Añadir nuevos
            filtered.forEach(p => {
                const icon = L.divIcon({
                    html: `<div style="background:#2E7D32;width:2rem;height:2rem;border-radius:50%;border:2px solid white;display:flex;justify-content:center;align-items:center;color:white;box-shadow:0 2px 4px rgba(0,0,0,0.3)"><i class="fa-solid fa-basket-shopping"></i></div>`,
                    className: '', iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32]
                });
                const marker = L.marker(p.coords, { icon }).addTo(mapInstanceRef.current);
                marker.bindPopup(`<div onclick="window.dispatchEvent(new CustomEvent('open-modal',{detail:${p.id}}))" style="cursor:pointer">
                    <img src="${p.image}" style="width:100%;height:8rem;object-fit:cover;border-radius:0.5rem 0.5rem 0 0" />
                    <div style="padding:0.75rem"><h3 style="font-weight:bold;margin-bottom:0.2rem">${p.name}</h3><p style="font-size:0.8rem;color:#666">${p.location}</p><button style="width:100%;background:#2E7D32;color:white;border:none;padding:0.4rem;border-radius:0.4rem;margin-top:0.5rem;font-size:0.75rem;cursor:pointer">Ver</button></div>
                </div>`);
                markersRef.current.push(marker);
            });
        }, [filtered]); // Se ejecuta cuando cambia 'filtered'

        return (
            <div className="flex flex-col md:flex-row h-full relative">
                {/* Mobile Search Overlay */}
                <div className="absolute top-4 left-4 right-4 z-20 md:w-[24rem] pointer-events-none">
                     <div className="bg-white p-2 rounded-xl shadow-lg pointer-events-auto flex gap-2">
                        <i className="fa-solid fa-search text-gray-400 p-3"></i>
                        <input 
                            type="text" 
                            placeholder="Buscar productos..." 
                            className="w-full outline-none text-sm"
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                        />
                     </div>
                </div>

                {/* Map Container usando REF */}
                <div ref={mapContainerRef} className="w-full h-full z-0 bg-gray-100"></div>
            </div>
        );
    };

    // 2. VISTA PRODUCTORES
    const ProducersView = ({ products, onSelect }) => (
        <div className="p-4 md:p-8 max-w-7xl mx-auto h-full overflow-y-auto pb-24 animate-fade-in">
            <div className="mb-8 text-center">
                <h2 className="text-3xl font-serif font-bold text-primary mb-2">Nuestros Artesanos</h2>
                <p className="text-gray-500 max-w-2xl mx-auto">Conoce a las personas detrás del producto. Apoya la economía local comprando directamente a quien lo produce.</p>
            </div>
            
            <div className="grid-responsive">
                {products.map(p => (
                    <div key={p.id} onClick={() => onSelect(p)} className="bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-lg transition cursor-pointer border border-gray-100 group">
                        <div className="h-32 bg-gray-200 relative">
                            <img src={p.image} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" />
                            <div className="absolute -bottom-6 left-4 w-12 h-12 rounded-full border-2 border-white overflow-hidden shadow-md z-10">
                                <img src={p.avatar} className="w-full h-full object-cover" />
                            </div>
                        </div>
                        <div className="pt-8 p-4">
                            <h3 className="font-bold text-lg text-gray-900">{p.producer}</h3>
                            <p className="text-xs text-gray-500 mb-3"><i className="fa-solid fa-location-dot"></i> {p.location}</p>
                            <div className="flex gap-2 mb-4">
                                {p.tags.map(t => <span key={t} className="bg-green-50 text-green-700 text-[0.6rem] px-2 py-0.5 rounded-full border border-green-100">{t}</span>)}
                            </div>
                            <button className="w-full border border-primary text-primary py-2 rounded-lg text-sm font-medium hover:bg-primary hover:text-white transition">Ver Perfil</button>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );

    // 3. VISTA RUTAS
    const RoutesView = () => (
        <div className="p-4 md:p-8 max-w-7xl mx-auto h-full overflow-y-auto pb-24 animate-fade-in">
             <div className="flex justify-between items-end mb-6">
                <div>
                    <h2 className="text-3xl font-serif font-bold text-secondary mb-1">Rutas RuralNow</h2>
                    <p className="text-gray-500 text-sm">Turismo vivencial y gastronómico.</p>
                </div>
                <button className="text-primary text-sm font-bold hover:underline">Ver todas</button>
            </div>

            <div className="space-y-6">
                {ROUTES.map((route, i) => (
                    <div key={route.id} className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col md:flex-row hover:shadow-md transition animate-slide-up" style={{animationDelay: `${i*100}ms`}}>
                        <div className="md:w-1/3 h-48 md:h-auto relative">
                            <img src={route.image} className="w-full h-full object-cover" />
                            <div className="absolute top-3 left-3 bg-white/90 px-3 py-1 rounded-full text-xs font-bold shadow-sm">
                                <i className="fa-regular fa-clock"></i> {route.duration}
                            </div>
                        </div>
                        <div className="p-6 md:w-2/3 flex flex-col justify-center">
                            <div className="flex justify-between items-start mb-2">
                                <span className="text-secondary text-xs font-bold uppercase tracking-wider">{route.location}</span>
                                <span className="text-gray-400 text-xs"><i className="fa-solid fa-flag"></i> {route.stops} Paradas</span>
                            </div>
                            <h3 className="text-xl font-bold text-gray-900 mb-2">{route.title}</h3>
                            <p className="text-gray-600 text-sm mb-4 leading-relaxed">{route.desc}</p>
                            <div className="flex gap-3 mt-auto">
                                <button className="bg-primary text-white px-5 py-2 rounded-lg text-sm font-medium hover:bg-green-800 transition">Comenzar Ruta</button>
                                <button className="text-gray-500 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50">Descargar PDF</button>
                            </div>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );

    // 4. VISTA PASAPORTE
    const PassportView = () => (
        <div className="p-4 md:p-8 max-w-4xl mx-auto h-full overflow-y-auto pb-24 animate-fade-in">
            <div className="bg-gradient-to-r from-primary to-green-800 rounded-2xl p-6 text-white mb-8 shadow-lg relative overflow-hidden">
                <div className="absolute top-0 right-0 p-8 opacity-10 text-9xl"><i className="fa-solid fa-passport"></i></div>
                <div className="flex items-center gap-6 relative z-10">
                    <div className="w-20 h-20 bg-white rounded-full p-1 shadow-lg">
                        <img src="https://randomuser.me/api/portraits/lego/1.jpg" className="w-full h-full rounded-full object-cover" />
                    </div>
                    <div>
                        <h2 className="text-2xl font-bold">Viajero Rural</h2>
                        <p className="text-green-100 text-sm mb-2">Nivel 3 • Guardián del Patrimonio</p>
                        <div className="w-48 h-2 bg-black/20 rounded-full overflow-hidden">
                            <div className="h-full bg-secondary w-[70%]"></div>
                        </div>
                        <p className="text-[0.65rem] mt-1 opacity-80">750/1000 XP para Nivel 4</p>
                    </div>
                </div>
            </div>

            <h3 className="font-bold text-gray-900 mb-4 flex items-center gap-2"><i className="fa-solid fa-medal text-yellow-500"></i> Tus Insignias</h3>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                {BADGES.map(badge => (
                    <div key={badge.id} className={`p-4 rounded-xl border text-center transition ${badge.unlocked ? 'bg-white border-gray-200' : 'bg-gray-50 border-gray-100 opacity-60 grayscale'}`}>
                        <div className={`w-12 h-12 mx-auto mb-3 rounded-full flex items-center justify-center text-xl shadow-sm ${badge.unlocked ? 'bg-orange-100 text-secondary' : 'bg-gray-200 text-gray-400'}`}>
                            <i className={`fa-solid ${badge.icon}`}></i>
                        </div>
                        <h4 className="font-bold text-sm text-gray-800">{badge.name}</h4>
                        <p className="text-[0.65rem] text-gray-500 mt-1 leading-tight">{badge.desc}</p>
                        {badge.unlocked && <span className="block mt-2 text-[0.6rem] text-green-600 font-bold">CONSEGUIDO</span>}
                    </div>
                ))}
            </div>

            <div className="mt-8 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h3 className="font-bold text-gray-900 mb-4">Tu Impacto Local</h3>
                <div className="grid grid-cols-3 gap-4 text-center divide-x divide-gray-100">
                    <div>
                        <div className="text-2xl font-bold text-primary">3</div>
                        <div className="text-[0.65rem] text-gray-500 uppercase">Pueblos Visitados</div>
                    </div>
                    <div>
                        <div className="text-2xl font-bold text-secondary">45€</div>
                        <div className="text-[0.65rem] text-gray-500 uppercase">Invertido en Local</div>
                    </div>
                    <div>
                        <div className="text-2xl font-bold text-blue-500">12kg</div>
                        <div className="text-[0.65rem] text-gray-500 uppercase">CO2 Ahorrado</div>
                    </div>
                </div>
            </div>
        </div>
    );

    // Main App Component
    const App = () => {
        const [activeTab, setActiveTab] = React.useState('map');
        const [selectedProduct, setSelectedProduct] = React.useState(null);

        React.useEffect(() => {
            const handleOpenModal = (e) => {
                const product = PRODUCTS.find(p => p.id === e.detail);
                setSelectedProduct(product);
            };
            window.addEventListener('open-modal', handleOpenModal);
            return () => window.removeEventListener('open-modal', handleOpenModal);
        }, []);

        const renderContent = () => {
            switch(activeTab) {
                case 'map': return <MapView products={PRODUCTS} onSelect={setSelectedProduct} />;
                case 'producers': return <ProducersView products={PRODUCTS} onSelect={setSelectedProduct} />;
                case 'routes': return <RoutesView />;
                case 'passport': return <PassportView />;
                default: return <MapView />;
            }
        };

        return (
            <div className="flex flex-col h-screen overflow-hidden">
                <Header activeTab={activeTab} onTabChange={setActiveTab} />
                <div className="flex-1 overflow-hidden relative bg-surface">
                    {renderContent()}
                </div>

                {selectedProduct && (
                    <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in">
                        <div className="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden relative">
                            <button onClick={() => setSelectedProduct(null)} className="absolute top-3 right-3 bg-white/80 p-1 rounded-full z-10 hover:bg-white transition"><i className="fa-solid fa-times"></i></button>
                            <img src={selectedProduct.image} className="w-full h-48 object-cover" />
                            <div className="p-6">
                                <h2 className="text-2xl font-bold font-serif text-gray-900">{selectedProduct.name}</h2>
                                <p className="text-secondary font-bold mb-2">{selectedProduct.price}</p>
                                <p className="text-sm text-gray-600 mb-4">{selectedProduct.story}</p>
                                <button className="w-full bg-primary text-white py-3 rounded-xl font-bold hover:bg-green-800 transition">Ir al Origen</button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

</script>
</body>
</html>